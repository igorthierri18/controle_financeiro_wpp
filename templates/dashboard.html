{% extends 'base.html' %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block custom_styles %}
.header-card {
    background-color: var(--primary-color);
    color: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    padding: 15px;
    position: relative;
    overflow: hidden;
}

.header-card h2 {
    font-size: 20px;
    margin-bottom: 5px;
}

.header-card p {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 0;
}

.header-card .subtitle {
    font-size: 14px;
    opacity: 0.8;
}

.header-card .icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 38px;
    opacity: 0.3;
}

.chart {
    height: 300px;
    width: 100%;
}

.period-buttons {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    padding: 10px 0;
    margin-bottom: 10px;
}

.period-buttons .btn {
    flex: 0 0 auto;
    border-radius: 20px;
    margin-right: 10px;
    font-size: 13px;
    padding: 6px 15px;
}

.transaction-date {
    font-size: 14px;
    font-weight: 500;
    margin-top: 15px;
    margin-bottom: 10px;
    color: var(--text-muted);
}

.expense-item {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.expense-item:last-child {
    border-bottom: none;
}

.expense-item-title {
    font-weight: 500;
    margin-bottom: 0;
    font-size: 14px;
}

.expense-item-subtitle {
    color: var(--text-muted);
    font-size: 12px;
}

.expense-item-amount {
    font-weight: 600;
    color: var(--secondary-color);
    font-size: 15px;
}

.category-pill {
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: 500;
}

.tab-content {
    padding-top: 15px;
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: white;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
}

.bottom-nav .nav-link {
    text-align: center;
    padding: 12px 0;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 10px;
}

.bottom-nav .nav-link.active {
    color: var(--primary-color);
}

.bottom-nav .nav-link i {
    font-size: 22px;
    margin-bottom: 2px;
}

.bottom-nav .fab-button {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 50px;
    background-color: var(--primary-color);
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

/* Estilos responsivos */
@media (max-width: 576px) {
    .header-card {
        margin-bottom: 15px;
        padding: 12px;
    }
    
    .header-card p {
        font-size: 24px;
    }
    
    .chart {
        height: 250px;
    }
    
    .card-header {
        padding: 12px 15px;
    }
}
{% endblock %}

{% block content %}
    <!-- Seletores de período -->
    <div class="period-buttons">
        <button class="btn btn-sm btn-outline-success period-btn" data-period="dia">Hoje</button>
        <button class="btn btn-sm btn-success period-btn" data-period="semana">Esta semana</button>
        <button class="btn btn-sm btn-outline-success period-btn" data-period="mes">Este mês</button>
        <button class="btn btn-sm btn-outline-success period-btn" data-period="ano">Este ano</button>
        <button class="btn btn-sm btn-outline-success period-btn" data-period="custom">Personalizado</button>
    </div>
    
    <!-- Cartões de resumo -->
    <div class="row">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="header-card">
                <h2>Despesas</h2>
                <p id="total-despesas">R$ 0,00</p>
                <span class="subtitle" id="period-subtitle">nesta semana</span>
                <div class="icon">
                    <i class="bi bi-cash"></i>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="header-card" style="background-color: #4a6cf7;">
                <h2>Receitas</h2>
                <p id="total-receitas">R$ 0,00</p>
                <span class="subtitle" id="period-subtitle-receitas">nesta semana</span>
                <div class="icon">
                    <i class="bi bi-wallet2"></i>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="header-card" style="background-color: #6440fb;">
                <h2>Saldo</h2>
                <p id="total-saldo">R$ 0,00</p>
                <span class="subtitle" id="period-subtitle-saldo">nesta semana</span>
                <div class="icon">
                    <i class="bi bi-piggy-bank"></i>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="header-card" style="background-color: #34c759;">
                <h2>Economia</h2>
                <p id="percentual-economia">0%</p>
                <span class="subtitle" id="period-subtitle-economia">nesta semana</span>
                <div class="icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico por categoria -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gráfico por categoria</span>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/api/exportar/despesas" download>Exportar CSV</a></li>
                    <li><a class="dropdown-item" href="#" id="btn-share-chart">Compartilhar via WhatsApp</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <div id="grafico-categoria" class="chart"></div>
        </div>
    </div>
    
    <!-- Últimas transações -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Últimas transações</span>
            <a href="#" class="text-decoration-none text-success">Ver todas</a>
        </div>
        <div class="card-body p-0">
            <ul class="nav nav-tabs nav-fill" id="transactionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-pane" type="button" role="tab">Todas</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="expense-tab" data-bs-toggle="tab" data-bs-target="#expense-pane" type="button" role="tab">Despesas</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="income-tab" data-bs-toggle="tab" data-bs-target="#income-pane" type="button" role="tab">Receitas</button>
                </li>
            </ul>
            <div class="tab-content" id="transactionTabsContent">
                <div class="tab-pane fade show active" id="all-pane" role="tabpanel" tabindex="0">
                    <div id="todas-transacoes">
                        <!-- As transações serão carregadas aqui -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="expense-pane" role="tabpanel" tabindex="0">
                    <div id="despesas-container">
                        <!-- As despesas serão carregadas aqui -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="income-pane" role="tabpanel" tabindex="0">
                    <div id="receitas-container">
                        <!-- As receitas serão carregadas aqui -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Barra de navegação inferior (apenas em mobile) -->
    <div class="bottom-nav d-md-none">
        <div class="container">
            <div class="row">
                <div class="col-3">
                    <a href="/dashboard" class="nav-link active">
                        <i class="bi bi-house-door"></i>
                        <span>Início</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="/relatorios" class="nav-link">
                        <i class="bi bi-graph-up"></i>
                        <span>Relatórios</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="/categorias" class="nav-link">
                        <i class="bi bi-tags"></i>
                        <span>Categorias</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="/perfil" class="nav-link">
                        <i class="bi bi-person"></i>
                        <span>Perfil</span>
                    </a>
                </div>
            </div>
            <a href="#" class="fab-button" data-bs-toggle="modal" data-bs-target="#modalAddTransacao">
                <i class="bi bi-plus"></i>
            </a>
        </div>
    </div>
    
    <!-- Modal para adicionar transação -->
    <div class="modal fade" id="modalAddTransacao" tabindex="-1" aria-labelledby="modalAddTransacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAddTransacaoLabel">Adicionar Transação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="transactionTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-despesa" data-bs-toggle="tab" data-bs-target="#despesa-tab-pane" type="button" role="tab">Despesa</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-receita" data-bs-toggle="tab" data-bs-target="#receita-tab-pane" type="button" role="tab">Receita</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="transactionTypeTabsContent">
                        <div class="tab-pane fade show active" id="despesa-tab-pane" role="tabpanel" tabindex="0">
                            <!-- Formulário de despesa -->
                            <form id="form-despesa">
                                <div class="mb-3">
                                    <label for="despesa-valor" class="form-label">Valor</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" class="form-control" id="despesa-valor" name="valor" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="despesa-descricao" class="form-label">Descrição</label>
                                    <input type="text" class="form-control" id="despesa-descricao" name="descricao" required>
                                </div>
                                <div class="mb-3">
                                    <label for="despesa-categoria" class="form-label">Categoria</label>
                                    <select class="form-select" id="despesa-categoria" name="categoria" required>
                                        <option value="alimentação">🍽️ Alimentação</option>
                                        <option value="transporte">🚗 Transporte</option>
                                        <option value="moradia">🏠 Moradia</option>
                                        <option value="saúde">⚕️ Saúde</option>
                                        <option value="educação">📚 Educação</option>
                                        <option value="lazer">🎭 Lazer</option>
                                        <option value="vestuário">👕 Vestuário</option>
                                        <option value="outros">📦 Outros</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="despesa-data" class="form-label">Data</label>
                                    <input type="date" class="form-control" id="despesa-data" name="data" required>
                                </div>
                                <div class="mb-3">
                                    <label for="despesa-forma-pagamento" class="form-label">Forma de Pagamento</label>
                                    <select class="form-select" id="despesa-forma-pagamento" name="forma_pagamento">
                                        <option value="">Selecione...</option>
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Débito">Cartão de Débito</option>
                                        <option value="Crédito">Cartão de Crédito</option>
                                        <option value="PIX">PIX</option>
                                        <option value="Transferência">Transferência Bancária</option>
                                        <option value="Boleto">Boleto</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="despesa-parcelada" name="parcelado">
                                    <label class="form-check-label" for="despesa-parcelada">
                                        Despesa parcelada
                                    </label>
                                </div>
                                <div class="mb-3" id="div-parcelas" style="display: none;">
                                    <label for="despesa-parcelas" class="form-label">Número de Parcelas</label>
                                    <input type="number" class="form-control" id="despesa-parcelas" name="num_parcelas" min="2" value="2">
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">Salvar Despesa</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="receita-tab-pane" role="tabpanel" tabindex="0">
                            <!-- Formulário de receita -->
                            <form id="form-receita">
                                <div class="mb-3">
                                    <label for="receita-valor" class="form-label">Valor</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" class="form-control" id="receita-valor" name="valor" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="receita-descricao" class="form-label">Descrição</label>
                                    <input type="text" class="form-control" id="receita-descricao" name="descricao" required>
                                </div>
                                <div class="mb-3">
                                    <label for="receita-categoria" class="form-label">Categoria</label>
                                    <select class="form-select" id="receita-categoria" name="categoria" required>
                                        <option value="salario">💰 Salário</option>
                                        <option value="freelance">💼 Freelance</option>
                                        <option value="investimento">📈 Investimento</option>
                                        <option value="presente">🎁 Presente</option>
                                        <option value="outros">📦 Outros</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="receita-data" class="form-label">Data</label>
                                    <input type="date" class="form-control" id="receita-data" name="data" required>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="receita-recorrente" name="recorrente">
                                    <label class="form-check-label" for="receita-recorrente">
                                        Receita recorrente
                                    </label>
                                </div>
                                <div class="mb-3" id="div-periodicidade" style="display: none;">
                                    <label for="receita-periodicidade" class="form-label">Periodicidade</label>
                                    <select class="form-select" id="receita-periodicidade" name="periodicidade">
                                        <option value="mensal">Mensal</option>
                                        <option value="quinzenal">Quinzenal</option>
                                        <option value="semanal">Semanal</option>
                                        <option value="anual">Anual</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">Salvar Receita</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Variáveis globais
    let periodoAtual = 'semana';
    let dadosGrafico = [];
    
    // Funções de formatação
    function formatarData(dataStr) {
        const data = new Date(dataStr);
        return data.toLocaleDateString('pt-BR');
    }
    
    function formatarValor(valor) {
        return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
    }
    
    // Carrega os dados com base no período selecionado
    async function carregarDados(periodo = 'semana') {
        periodoAtual = periodo;
        
        // Atualiza os subtítulos com o período selecionado
        let textoPeríodo = 'nesta semana';
        if (periodo === 'dia') textoPeríodo = 'hoje';
        if (periodo === 'mes') textoPeríodo = 'neste mês';
        if (periodo === 'ano') textoPeríodo = 'neste ano';
        
        document.getElementById('period-subtitle').textContent = textoPeríodo;
        document.getElementById('period-subtitle-receitas').textContent = textoPeríodo;
        document.getElementById('period-subtitle-saldo').textContent = textoPeríodo;
        document.getElementById('period-subtitle-economia').textContent = textoPeríodo;
        
        try {
            // Carrega o resumo
            const resumoResponse = await fetch(`/api/resumo?periodo=${periodo}`);
            const resumo = await resumoResponse.json();
            
            // Atualiza os totais
            document.getElementById('total-despesas').textContent = formatarValor(resumo.total_despesas);
            document.getElementById('total-receitas').textContent = formatarValor(resumo.total_receitas);
            document.getElementById('total-saldo').textContent = formatarValor(resumo.saldo);
            document.getElementById('percentual-economia').textContent = `${resumo.economia_percentual}%`;
            
            // Carrega o gráfico por categoria
            const graficoResponse = await fetch(`/api/grafico/por_categoria?periodo=${periodo}`);
            const dadosGrafico = await graficoResponse.json();
            
            // Atualiza o gráfico
            atualizarGrafico(dadosGrafico);
            
            // Carrega as despesas
            const despesasResponse = await fetch(`/api/despesas?periodo=${periodo}`);
            const despesas = await despesasResponse.json();
            
            // Carrega as receitas
            const receitasResponse = await fetch(`/api/receitas?periodo=${periodo}`);
            const receitas = await receitasResponse.json();
            
            // Atualiza as listas de transações
            atualizarListaTransacoes(despesas, receitas);
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            // Mostra mensagem de erro
            alert('Ocorreu um erro ao carregar os dados. Por favor, tente novamente.');
        }
    }
    
    // Atualiza o gráfico de categorias
    function atualizarGrafico(dados) {
        if (!dados || !dados.data) {
            console.error('Dados do gráfico inválidos');
            return;
        }
        
        // Renderiza o gráfico com Plotly
        Plotly.newPlot('grafico-categoria', dados.data, dados.layout, {responsive: true});
        
        // Armazena os dados para uso posterior
        dadosGrafico = dados;
    }
    
    // Função para agrupar transações por data
    function agruparTransacoesPorData(transacoes) {
        const grupos = {};
        
        transacoes.forEach(transacao => {
            const data = transacao.data;
            if (!grupos[data]) {
                grupos[data] = [];
            }
            grupos[data].push(transacao);
        });
        
        return grupos;
    }
    
    // Função para criar HTML de uma transação
    function criarHTMLTransacao(transacao, isReceita = false) {
        // Determina o emoji/ícone baseado na categoria
        let emoji = '📦'; // Padrão
        let categoriaClass = 'category-outros';
        
        if (isReceita) {
            emoji = '💰';
            categoriaClass = 'bg-success';
            
            // Ícones específicos para categorias de receita
            if (transacao.categoria === 'salario') emoji = '💵';
            if (transacao.categoria === 'freelance') emoji = '💼';
            if (transacao.categoria === 'investimento') emoji = '📈';
            if (transacao.categoria === 'presente') emoji = '🎁';
        } else {
            // Mapa de categorias para emojis
            const emojisCategoria = {
                'alimentação': '🍽️',
                'transporte': '🚗',
                'moradia': '🏠',
                'saúde': '⚕️',
                'educação': '📚',
                'lazer': '🎭',
                'vestuário': '👕',
                'outros': '📦'
            };
            
            emoji = emojisCategoria[transacao.categoria] || '📦';
            categoriaClass = `category-${transacao.categoria}`;
        }
        
        // Formata data e hora
        const dataObj = new Date(transacao.data + 'T00:00:00');
        const dataFormatada = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
        
        // Formata o valor com sinal + ou -
        const valorFormatado = formatarValor(transacao.valor);
        
        return `
        <div class="expense-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="category-pill me-3 ${categoriaClass} text-white">${emoji}</div>
                <div>
                    <h6 class="expense-item-title">${transacao.descricao}</h6>
                    <p class="expense-item-subtitle">${dataFormatada} • ${isReceita ? 'Receita' : transacao.categoria.charAt(0).toUpperCase() + transacao.categoria.slice(1)}</p>
                </div>
            </div>
            <div class="expense-item-amount" style="color: ${isReceita ? '#28a745' : '#e74c3c'}">${isReceita ? '+' : '-'} ${valorFormatado}</div>
        </div>
        `;
    }
    
    // Atualiza a lista de transações
    function atualizarListaTransacoes(despesas, receitas) {
        // Agrupa transações por data
        const despesasPorData = agruparTransacoesPorData(despesas);
        const receitasPorData = agruparTransacoesPorData(receitas);
        
        // Combina todas as datas únicas
        const todasDatas = [...new Set([...Object.keys(despesasPorData), ...Object.keys(receitasPorData)])].sort().reverse();
        
        // Containers para as listas
        const todasTransacoesContainer = document.getElementById('todas-transacoes');
        const despesasContainer = document.getElementById('despesas-container');
        const receitasContainer = document.getElementById('receitas-container');
        
        // Limpa os containers
        todasTransacoesContainer.innerHTML = '';
        despesasContainer.innerHTML = '';
        receitasContainer.innerHTML = '';
        
        // Se não há transações
        if (todasDatas.length === 0) {
            const mensagemVazia = `
            <div class="text-center py-5">
                <i class="bi bi-receipt text-muted" style="font-size: 48px;"></i>
                <p class="mt-3 text-muted">Nenhuma transação encontrada neste período.</p>
            </div>
            `;
            todasTransacoesContainer.innerHTML = mensagemVazia;
            despesasContainer.innerHTML = mensagemVazia;
            receitasContainer.innerHTML = mensagemVazia;
            return;
        }
        
        // Preenche as listas
        todasDatas.forEach(data => {
            const dataObj = new Date(data + 'T00:00:00');
            const dataFormatada = dataObj.toLocaleDateString('pt-BR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            // Para todas as transações
            if (despesasPorData[data] || receitasPorData[data]) {
                todasTransacoesContainer.innerHTML += `<div class="transaction-date ps-3">${dataFormatada}</div>`;
                
                // Adiciona despesas
                if (despesasPorData[data]) {
                    despesasPorData[data].forEach(despesa => {
                        todasTransacoesContainer.innerHTML += criarHTMLTransacao(despesa, false);
                    });
                }
                
                // Adiciona receitas
                if (receitasPorData[data]) {
                    receitasPorData[data].forEach(receita => {
                        todasTransacoesContainer.innerHTML += criarHTMLTransacao(receita, true);
                    });
                }
            }
            
            // Para despesas
            if (despesasPorData[data]) {
                despesasContainer.innerHTML += `<div class="transaction-date ps-3">${dataFormatada}</div>`;
                despesasPorData[data].forEach(despesa => {
                    despesasContainer.innerHTML += criarHTMLTransacao(despesa, false);
                });
            }
            
            // Para receitas
            if (receitasPorData[data]) {
                receitasContainer.innerHTML += `<div class="transaction-date ps-3">${dataFormatada}</div>`;
                receitasPorData[data].forEach(receita => {
                    receitasContainer.innerHTML += criarHTMLTransacao(receita, true);
                });
            }
        });
    }
    
    // Event listener para os botões de período
    document.querySelectorAll('.period-btn').forEach(botao => {
        botao.addEventListener('click', function() {
            // Remove a classe ativa de todos os botões
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            });
            
            // Adiciona a classe ativa ao botão clicado
            this.classList.remove('btn-outline-success');
            this.classList.add('btn-success');
            
            // Carrega os dados para o período selecionado
            carregarDados(this.dataset.period);
        });
    });
    
    // Event listener para o formulário de despesa
    document.getElementById('form-despesa').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Cria um objeto FormData com os dados do formulário
        const formData = new FormData(this);
        
        // Converte FormData para objeto JSON
        const dadosDespesa = {};
        formData.forEach((valor, chave) => {
            // Converte checkboxes para 0 ou 1
            if (chave === 'parcelado') {
                dadosDespesa[chave] = valor === 'on' ? 1 : 0;
            } else {
                dadosDespesa[chave] = valor;
            }
        });
        
        try {
            // Envia os dados para a API
            const response = await fetch('/api/despesas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosDespesa)
            });
            
            if (response.ok) {
                // Fecha o modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAddTransacao'));
                modal.hide();
                
                // Recarrega os dados
                carregarDados(periodoAtual);
                
                // Limpa o formulário
                this.reset();
                
                // Define a data para hoje
                document.getElementById('despesa-data').valueAsDate = new Date();
                
                // Mostra mensagem de sucesso
                alert('Despesa adicionada com sucesso!');
            } else {
                const erro = await response.json();
                alert(`Erro: ${erro.error || 'Ocorreu um erro ao adicionar a despesa.'}`);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Ocorreu um erro ao adicionar a despesa. Por favor, tente novamente.');
        }
    });
    
    // Event listener para o formulário de receita
    document.getElementById('form-receita').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Cria um objeto FormData com os dados do formulário
        const formData = new FormData(this);
        
        // Converte FormData para objeto JSON
        const dadosReceita = {};
        formData.forEach((valor, chave) => {
            // Converte checkboxes para 0 ou 1
            if (chave === 'recorrente') {
                dadosReceita[chave] = valor === 'on' ? 1 : 0;
            } else {
                dadosReceita[chave] = valor;
            }
        });
        
        try {
            // Envia os dados para a API
            const response = await fetch('/api/receitas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosReceita)
            });
            
            if (response.ok) {
                // Fecha o modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAddTransacao'));
                modal.hide();
                
                // Recarrega os dados
                carregarDados(periodoAtual);
                
                // Limpa o formulário
                this.reset();
                
                // Define a data para hoje
                document.getElementById('receita-data').valueAsDate = new Date();
                
                // Mostra mensagem de sucesso
                alert('Receita adicionada com sucesso!');
            } else {
                const erro = await response.json();
                alert(`Erro: ${erro.error || 'Ocorreu um erro ao adicionar a receita.'}`);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Ocorreu um erro ao adicionar a receita. Por favor, tente novamente.');
        }
    });
    
    // Event listener para mostrar/esconder campos adicionais
    document.getElementById('despesa-parcelada').addEventListener('change', function() {
        document.getElementById('div-parcelas').style.display = this.checked ? 'block' : 'none';
    });
    
    document.getElementById('receita-recorrente').addEventListener('change', function() {
        document.getElementById('div-periodicidade').style.display = this.checked ? 'block' : 'none';
    });
    
    // Botão para compartilhar gráfico via WhatsApp
    document.getElementById('btn-share-chart').addEventListener('click', function() {
        // Obtém a URL da imagem do gráfico
        const urlGrafico = `/api/grafico/imagem?tipo=categoria&periodo=${periodoAtual}`;
        
        // Cria a URL do WhatsApp
        const textoCompartilhamento = `Veja meu resumo financeiro ${periodoAtual === 'dia' ? 'de hoje' : 
                                      periodoAtual === 'semana' ? 'desta semana' : 
                                      periodoAtual === 'mes' ? 'deste mês' : 'deste ano'}:`;
        const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(textoCompartilhamento + "\n" + urlGrafico)}`;
        
        // Abre a URL
        window.open(urlWhatsApp, '_blank');
    });
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // Define a data atual como padrão para os campos de data
        const hoje = new Date();
        document.getElementById('despesa-data').valueAsDate = hoje;
        document.getElementById('receita-data').valueAsDate = hoje;
        
        // Carrega os dados iniciais
        carregarDados(periodoAtual);
    });
</script>
{% endblock %}